import{ConcatSource as e}from"webpack-sources";const t=require("path");function s(e,t){return 0===this.indexOf(e)?this.replace(e,t):this}export default class{constructor(e){var o;let n=e.nodeModulesOutputDir||"mp_node_modules/";n=s.call(n,".",""),n=s.call(n,"/",""),"/"===n[n.length-1]&&(n=n.substr(0,n.length-1)),this.state={nodeModules:[],nodeModulesPath:t.resolve(process.cwd(),"node_modules"),utilModules:[],utilModulesPaths:(null===(o=null==e?void 0:e.libPaths)||void 0===o?void 0:o.filter((e=>-1===e.indexOf("node_modules"))).map((e=>t.resolve(process.cwd(),e))))||[],nodeModulesOutputDir:n,options:e}}getNewChunkName(e="",o,n=""){let u="";if(o instanceof Array){const t=o.find((t=>e.indexOf(t)>=0));t&&(u=s.call(e.split(t)[1],"/",""),n=this.state.options.libPaths.find((e=>t.indexOf(e)>=0))||"",n=s.call(n,".",""),n=s.call(n,"/",""),n=s.call(n,"src/",""))}else u=e.split(o)[1];return u=u.replace(t.extname(u),""),`${n?n+("/"===n[n.length-1]?"":"/"):""}${u}`}createNewChunkForModule(e,t,s){const o=t.resource||t.context,n=this.getNewChunkName(o,o.indexOf("node_modules/")>=0?"node_modules/":this.state.utilModulesPaths,s),u=e.addChunk(n);return u.addModule(t),t.addChunk(u),!0}removeModulesAllChunks(e){for(const t of e.getChunks())e.removeChunk(t)}iterateAllModules(e){e.forEach((e=>{const t=e.resource||e.context;if(t.indexOf(this.state.nodeModulesPath)>=0||t.indexOf("node_modules/")>=0){if(this.removeModulesAllChunks(e),t.match(/\/moment\/locale/))return;return void this.state.nodeModules.push(e)}if(this.state.utilModulesPaths.find((e=>t.indexOf(e)>=0)))return this.removeModulesAllChunks(e),void this.state.utilModules.push(e)}))}resolveChunkNameAfterOptimization(e){const{nodeModulesOutputDir:t}=this.state;e.name.indexOf(t)>0&&(e.name=`${t}${e.name.split(t)[1]}`)}appendAssetContent(t,s){const o=t.source(),n=s.map((e=>`require("${e}");`));return new e(...n,o)}appendRequireStatements(e,s){const o=s.chunks,n=s.modules,{nodeModulesOutputDir:u}=this.state;o.forEach((s=>{const o=[];s.getModules().forEach((e=>{-1!==e.type.indexOf("javascript")&&e.resource&&t.extname(e.resource).match(/\.(ts|js|mjs)$/)&&e.dependencies.forEach((s=>{if(!s.module||!s.module.resource)return;if(!t.extname(s.module.resource).match(/\.(ts|js|mjs)$/))return;let n=t.relative(t.dirname(e.resource),s.module.resource).replace("node_modules",u).replace(/\.(ts|mjs)/,".js");e.resource.indexOf("/src")>=0&&-1===s.module.resource.indexOf("/src")&&(n=n.replace("../","")),-1===o.indexOf(n)&&o.push(n)}))})),n.forEach((e=>{-1!==e.type.indexOf("javascript")&&e.resource&&-1!==e.resource.indexOf("node_modules")&&t.extname(e.resource).match(/\.(ts|js|mjs)$/)&&e.reasons.forEach((n=>{if(!n.module.resource)return;let r=`${u}${n.module.resource.split("node_modules")[1]}`;r=r.replace(t.extname(r),"");let i=`${u}${e.resource.split("node_modules")[1]}`;if(s.name!==r)return;const l=t.relative(t.dirname(r),i).replace(/\.(ts|mjs)/,".js");-1===o.indexOf(l)&&o.push(l)}))})),o.length>0&&(e[`${s.name}.js`]=this.appendAssetContent(e[`${s.name}.js`],o))})),e["app.js"].source().match(/require\((\"|\')runtime(\.js)?(\"|\')\)/g)||(e["app.js"]=this.appendAssetContent(e["app.js"],["runtime"]))}apply(e){e.hooks.environment.tap("WxWebpackPlugin",(()=>{e.options.optimization.runtimeChunk={name:"runtime"}})),e.hooks.thisCompilation.tap("WxWebpackPlugin",(e=>{e.hooks.optimizeModules.tap("WxWebpackPlugin",(e=>{this.iterateAllModules(e)})),e.hooks.optimizeChunks.tap("WxWebpackPlugin",(t=>{this.state.nodeModules.forEach((t=>this.createNewChunkForModule(e,t,this.state.nodeModulesOutputDir))),this.state.utilModules.forEach((t=>this.createNewChunkForModule(e,t,"")))})),e.hooks.afterOptimizeChunks.tap("WxWebpackPlugin",(e=>{e.forEach((e=>this.resolveChunkNameAfterOptimization(e)))})),e.hooks.optimizeAssets.tapAsync("WxWebpackPlugin",((t,s)=>{this.appendRequireStatements(t,e),s()}))}))}}
//# sourceMappingURL=index.esm.min.js.map
